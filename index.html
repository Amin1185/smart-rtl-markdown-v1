<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Previewer</title>
    <meta name="description" content="Smart RTL-aware Markdown previewer with MathJax, Prism, and Tailwind-like styles.">
    
    <!-- =============================================
         EXTERNAL DEPENDENCIES
         ============================================= -->
    
    <!-- Tailwind CSS - Utility-first CSS framework -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Marked.js - Fast Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- DOMPurify - XSS sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    
    <!-- Prism.js - Syntax highlighting for code blocks -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- html2pdf.js - PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- MathJax - LaTeX math rendering with RTL language support -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            },
            chtml: {
                mtextInheritFont: true,
                scale: 1
            },
            svg: {
                mtextInheritFont: true,
                scale: 1
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    window.mathJaxReady = true;
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Google Fonts - Vazirmatn for Persian, Inter for Latin, JetBrains Mono for code -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- =============================================
         STYLES
         ============================================= -->
    <style>
        /* ----- CSS Variables ----- */
        :root {
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Vazirmatn', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }

        /* ----- Card Styling ----- */
        .card {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-sm);
            border-radius: var(--border-radius);
        }

        /* ----- Editor Textarea ----- */
        .editor-textarea {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.7;
            resize: none;
            background: #1e293b;
            color: #e2e8f0;
            border: none;
        }

        .editor-textarea::placeholder {
            color: #64748b;
        }

        .editor-textarea:focus {
            outline: none;
        }

        /* ----- Preview Container ----- */
        .preview-container {
            overflow-y: auto;
            overflow-x: hidden;
        }

        .markdown-inner {
            width: 100%;
            max-width: 100%;
        }

        /* ----- Markdown Output Base Styles ----- */
        .markdown-body {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            line-height: 1.8;
            color: #334155;
        }

        /* ----- RTL/LTR Direction Handling ----- */
        .markdown-body [dir="rtl"] {
            direction: rtl;
            text-align: right;
        }

        .markdown-body [dir="ltr"] {
            direction: ltr;
            text-align: left;
        }

        /* ----- Line Block Styling ----- */
        .markdown-body .line-block {
            display: block;
        }

        .markdown-body .line-block[dir="rtl"] {
            direction: rtl;
            text-align: right;
        }

        .markdown-body .line-block[dir="ltr"] {
            direction: ltr;
            text-align: left;
        }

        .markdown-body ul[dir="rtl"],
        .markdown-body ol[dir="rtl"] {
            padding-left: 0;
            padding-right: 2em;
        }

        .markdown-body ul[dir="ltr"],
        .markdown-body ol[dir="ltr"] {
            padding-left: 2em;
            padding-right: 0;
        }

        .markdown-body blockquote[dir="rtl"] {
            border-left: none;
            border-right: 3px solid #cbd5e1;
            padding-right: 1em;
            padding-left: 0;
        }

        .markdown-body blockquote[dir="ltr"] {
            border-right: none;
            border-left: 3px solid #cbd5e1;
            padding-left: 1em;
            padding-right: 0;
        }

        /* ----- Typography ----- */
        .markdown-body h1 {
            font-size: 1.875em;
            font-weight: 700;
            margin: 0.67em 0;
            color: #0f172a;
        }

        .markdown-body h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0.83em 0;
            color: #1e293b;
        }

        .markdown-body h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 1em 0;
            color: #334155;
        }

        .markdown-body h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 1em 0;
            color: #475569;
        }

        .markdown-body p {
            margin-bottom: 1em;
            color: #475569;
            overflow-wrap: break-word;
        }

        .markdown-body strong {
            font-weight: 600;
            color: #1e293b;
        }

        .markdown-body em {
            font-style: italic;
        }

        /* ----- Lists ----- */
        .markdown-body ul,
        .markdown-body ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }

        .markdown-body ul {
            list-style-type: disc;
        }

        .markdown-body ol {
            list-style-type: decimal;
        }

        .markdown-body li {
            margin-bottom: 0.25em;
            color: #475569;
        }

        /* ----- Links ----- */
        .markdown-body a {
            color: #2563eb;
            text-decoration: none;
        }

        .markdown-body a:hover {
            text-decoration: underline;
        }

        /* ----- Inline Code ----- */
        .markdown-body code:not([class*="language-"]) {
            background: #f1f5f9;
            padding: 0.15em 0.4em;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
            color: #0f172a;
            unicode-bidi: isolate;
            direction: ltr;
            display: inline-block;
            vertical-align: baseline;
            white-space: nowrap;
        }

        /* ----- Code Block Wrapper ----- */
        .code-block-wrapper {
            margin: 1em 0;
            border-radius: 8px;
            overflow: hidden;
            background: #1e293b;
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
        }

        .code-lang {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #94a3b8;
        }

        .copy-btn {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            padding: 4px 12px;
            background: #334155;
            color: #e2e8f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .copy-btn:hover {
            background: #475569;
        }

        .copy-btn.copied {
            background: #22c55e;
            color: white;
        }

        .copy-btn svg {
            width: 14px;
            height: 14px;
        }

        /* ----- Code Blocks ----- */
        .markdown-body pre {
            margin: 1em 0;
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            direction: ltr !important;
            text-align: left !important;
        }

        .code-block-wrapper pre {
            margin: 0 !important;
            border-radius: 0 !important;
        }

        .markdown-body pre code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
            line-height: 1.6;
            display: block;
            unicode-bidi: normal;
            white-space: pre;
        }

        /* ----- Blockquotes ----- */
        .markdown-body blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            background: #f8fafc;
            border-left: 3px solid #cbd5e1;
            color: #64748b;
            overflow-x: auto;
        }

        /* ----- Horizontal Rules ----- */
        .markdown-body hr {
            border: none;
            height: 1px;
            background: #e2e8f0;
            margin: 2em 0;
        }

        /* ----- Tables ----- */
        .markdown-body .table-wrapper {
            overflow-x: auto;
            margin: 1em 0;
            max-width: 100%;
        }

        .markdown-body table {
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
        }

        .markdown-body th,
        .markdown-body td {
            padding: 0.5em 1em;
            border: 1px solid #e2e8f0;
            text-align: left;
            white-space: nowrap;
        }

        .markdown-body th {
            background: #f8fafc;
            font-weight: 600;
            color: #334155;
        }

        .markdown-body td {
            background: white;
        }

        /* ----- MathJax Inline ----- */
        mjx-container:not([display="true"]) {
            display: inline-block !important;
            overflow: visible !important;
            vertical-align: middle !important;
            margin: 0 2px !important;
            padding: 0 !important;
            max-width: none !important;
        }

        /* ----- MathJax Block/Display ----- */
        .math-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            margin: 1em 0;
            max-width: 100%;
        }

        mjx-container[display="true"] {
            display: block !important;
            margin: 0 auto !important;
            padding: 1em;
            background: #fffbeb;
            border-radius: 8px;
            border: 1px solid #fef3c7;
            text-align: center !important;
            direction: ltr !important;
            width: max-content;
            min-width: 100%;
        }

        mjx-mtext {
            font-family: 'Vazirmatn', 'Inter', sans-serif !important;
        }

        /* ----- Footnotes ----- */
        .markdown-body .footnotes {
            margin-top: 2em;
            padding-top: 1em;
            border-top: 1px solid #e2e8f0;
            font-size: 0.9em;
            color: #64748b;
        }

        .markdown-body .footnotes ol {
            padding-left: 1.5em;
        }

        .markdown-body .footnotes li {
            margin-bottom: 0.5em;
        }

        .markdown-body .footnotes li p {
            display: inline;
            margin: 0;
        }

        .markdown-body .footnote-ref {
            font-size: 0.75em;
            vertical-align: super;
            line-height: 0;
        }

        .markdown-body .footnote-ref a {
            text-decoration: none;
            color: #2563eb;
            padding: 0 2px;
        }

        .markdown-body .footnote-ref a:hover {
            text-decoration: underline;
        }

        .markdown-body .footnote-backref {
            text-decoration: none;
            margin-left: 0.5em;
        }

        /* ----- BDI Elements ----- */
        .markdown-body bdi {
            unicode-bidi: isolate;
        }

        /* ----- Scrollbar Styling ----- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .editor-textarea::-webkit-scrollbar-track,
        pre::-webkit-scrollbar-track {
            background: #334155;
        }

        .editor-textarea::-webkit-scrollbar-thumb,
        pre::-webkit-scrollbar-thumb {
            background: #64748b;
        }

        /* ----- Panel Header ----- */
        .panel-header {
            display: flex;
            gap: 6px;
            padding: 10px 14px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }

        .panel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .panel-dot.red { background: #f87171; }
        .panel-dot.yellow { background: #fbbf24; }
        .panel-dot.green { background: #4ade80; }

        /* ----- Status Badge ----- */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-badge.mixed { background: #f1f5f9; color: #475569; }
        .status-badge.rtl { background: #fef3c7; color: #92400e; }
        .status-badge.ltr { background: #dbeafe; color: #1e40af; }

        /* ----- Stats Display ----- */
        .stats-text {
            font-size: 12px;
            color: #64748b;
        }

        /* ----- Toolbar Styling ----- */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            font-weight: 500;
            color: #475569;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
            color: #334155;
        }

        .toolbar-btn:active {
            transform: scale(0.98);
        }

        .toolbar-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .toolbar-btn svg {
            width: 16px;
            height: 16px;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: #e2e8f0;
            margin: 0 8px;
        }

        .toolbar-label {
            font-size: 12px;
            color: #94a3b8;
            margin-right: 8px;
        }

        .auto-save-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            font-size: 12px;
            color: #94a3b8;
        }

        .auto-save-indicator.saving {
            color: #f59e0b;
        }

        .auto-save-indicator.saved {
            color: #22c55e;
        }

        .auto-save-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #94a3b8;
        }

        .auto-save-indicator.saving .auto-save-dot {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        .auto-save-indicator.saved .auto-save-dot {
            background: #22c55e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ----- Sync Scroll Toggle ----- */
        .sync-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
            cursor: pointer;
            user-select: none;
        }

        .sync-toggle input {
            display: none;
        }

        .sync-toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: #cbd5e1;
            border-radius: 10px;
            transition: all 0.2s;
        }

        .sync-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .sync-toggle input:checked + .sync-toggle-switch {
            background: #3b82f6;
        }

        .sync-toggle input:checked + .sync-toggle-switch::after {
            left: 18px;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- =============================================
         HEADER
         ============================================= -->
    <header class="bg-white border-b border-slate-200 py-4">
        <div class="container mx-auto px-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-slate-100 rounded-lg">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-slate-800">Markdown Previewer</h1>
                        <p class="text-xs text-slate-500">MathJax ‚Ä¢ Syntax Highlighting ‚Ä¢ Smart RTL</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-xs text-slate-500">
                    <span>üìù Markdown</span>
                    <span>üî¢ LaTeX</span>
                    <span>üîÑ RTL/LTR</span>
                </div>
            </div>
        </div>
    </header>

    <!-- =============================================
         TOOLBAR
         ============================================= -->
    <div class="toolbar">
        <span class="toolbar-label">Export:</span>
        <button class="toolbar-btn" id="download-md-btn" title="Download as Markdown">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m.75 12l3 3m0 0l3-3m-3 3v-6m-1.5-9H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
            Download .md
        </button>
        <button class="toolbar-btn" id="download-html-btn" title="Download as HTML">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" />
            </svg>
            Download .html
        </button>
        <button class="toolbar-btn" id="download-pdf-btn" title="Download as PDF">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
            Download .pdf
        </button>
        
        <div class="toolbar-divider"></div>
        
        <label class="sync-toggle" title="Synchronize scrolling between editor and preview">
            <input type="checkbox" id="sync-scroll-toggle" checked>
            <span class="sync-toggle-switch"></span>
            <span>Sync Scroll</span>
        </label>
        
        <div class="toolbar-divider"></div>
        
        <button class="toolbar-btn" id="clear-storage-btn" title="Clear saved content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
            </svg>
            Clear Saved
        </button>
        
        <div class="auto-save-indicator" id="auto-save-indicator">
            <span class="auto-save-dot"></span>
            <span id="auto-save-text">Auto-save enabled</span>
        </div>
    </div>

    <!-- =============================================
         MAIN CONTENT - Editor and Preview Panels
         ============================================= -->
    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            
            <!-- Editor Panel -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium text-slate-600">Editor</span>
                    <div class="stats-text" id="stats">
                        <span id="word-count">0 words</span> ¬∑ <span id="char-count">0 chars</span>
                    </div>
                </div>
                
                <div class="card overflow-hidden flex-1 flex flex-col">
                    <div class="panel-header">
                        <div class="panel-dot red"></div>
                        <div class="panel-dot yellow"></div>
                        <div class="panel-dot green"></div>
                        <span class="text-slate-400 text-xs ml-3 font-mono">document.md</span>
                    </div>
                    <textarea
                        id="markdown-input"
                        class="editor-textarea w-full flex-1 p-4 min-h-[550px]"
                        placeholder="Start typing Markdown here..."
                        spellcheck="false"
                    ></textarea>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium text-slate-600">Preview</span>
                    <div class="flex items-center gap-2">
                        <span class="stats-text" id="direction-stats">RTL: 0 ¬∑ LTR: 0</span>
                        <div id="direction-indicator">
                            <span class="status-badge ltr">LTR</span>
                        </div>
                    </div>
                </div>
                
                <div class="card overflow-hidden flex-1 flex flex-col">
                    <div class="flex items-center gap-2 px-4 py-2.5 bg-slate-50 border-b border-slate-200">
                        <div class="flex gap-1.5">
                            <div class="w-2.5 h-2.5 rounded-full bg-rose-400"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-emerald-400"></div>
                        </div>
                        <span class="text-slate-400 text-xs ml-2 font-mono">preview.html</span>
                    </div>
                    <div
                        id="markdown-output"
                        class="markdown-body preview-container p-6 min-h-[550px] flex-1"
                    >
                        <p class="text-slate-400 text-center italic">Your preview will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- =============================================
         FOOTER
         ============================================= -->
    <footer class="text-center py-4 text-slate-400 text-xs border-t border-slate-100">
        <p>Marked.js ¬∑ MathJax ¬∑ Prism.js ¬∑ DOMPurify</p>
    </footer>

    <!-- =============================================
         JAVASCRIPT
         ============================================= -->
    <script>
        // =============================================
        // CONSTANTS
        // =============================================
        
        const STORAGE_KEY = 'markdown-previewer-content';
        const STORAGE_TIMESTAMP_KEY = 'markdown-previewer-timestamp';

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // =============================================
        // AUTO-SAVE FUNCTIONALITY
        // =============================================

        const autoSaveIndicator = document.getElementById('auto-save-indicator');
        const autoSaveText = document.getElementById('auto-save-text');

        function saveToLocalStorage(content) {
            try {
                localStorage.setItem(STORAGE_KEY, content);
                localStorage.setItem(STORAGE_TIMESTAMP_KEY, Date.now().toString());
                showSaveStatus('saved');
            } catch (e) {
                console.warn('Failed to save to localStorage:', e);
                showSaveStatus('error');
            }
        }

        function loadFromLocalStorage() {
            try {
                const content = localStorage.getItem(STORAGE_KEY);
                const timestamp = localStorage.getItem(STORAGE_TIMESTAMP_KEY);
                return { content, timestamp };
            } catch (e) {
                console.warn('Failed to load from localStorage:', e);
                return { content: null, timestamp: null };
            }
        }

        function clearLocalStorage() {
            try {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(STORAGE_TIMESTAMP_KEY);
                return true;
            } catch (e) {
                console.warn('Failed to clear localStorage:', e);
                return false;
            }
        }

        function showSaveStatus(status) {
            autoSaveIndicator.classList.remove('saving', 'saved');
            
            if (status === 'saving') {
                autoSaveIndicator.classList.add('saving');
                autoSaveText.textContent = 'Saving...';
            } else if (status === 'saved') {
                autoSaveIndicator.classList.add('saved');
                const now = new Date();
                autoSaveText.textContent = `Saved at ${now.toLocaleTimeString()}`;
            } else if (status === 'error') {
                autoSaveText.textContent = 'Save failed';
            }
        }

        const debouncedSave = debounce((content) => {
            saveToLocalStorage(content);
        }, 1000);

        function handleAutoSave() {
            showSaveStatus('saving');
            debouncedSave(markdownInput.value);
        }

        // =============================================
        // DOMPURIFY CONFIGURATION
        // =============================================

        const purifyConfig = {
            ADD_TAGS: ['bdi', 'mjx-container', 'mjx-math', 'mjx-mrow', 'mjx-mi', 'mjx-mo', 
                       'mjx-mn', 'mjx-mtext', 'mjx-msup', 'mjx-msub', 'mjx-mfrac', 
                       'mjx-msqrt', 'mjx-mroot', 'mjx-mtable', 'mjx-mtr', 'mjx-mtd',
                       'mjx-assistive-mml', 'mjx-merror', 'mjx-mpadded', 'mjx-mspace',
                       'mjx-mstyle', 'mjx-munder', 'mjx-mover', 'mjx-munderover'],
            ADD_ATTR: ['dir', 'display', 'jax', 'justify', 'texclass', 'data-semantic-type'],
            ALLOW_DATA_ATTR: true,
            USE_PROFILES: { html: true, svg: true, svgFilters: true, mathMl: true }
        };

        function sanitizeHtml(html) {
            if (typeof DOMPurify !== 'undefined') {
                return DOMPurify.sanitize(html, purifyConfig);
            }
            console.warn('DOMPurify not loaded, returning unsanitized HTML');
            return html;
        }

        // =============================================
        // COPY CODE FUNCTIONALITY
        // =============================================

        function copyCode(btn) {
            const wrapper = btn.closest('.code-block-wrapper');
            const codeEl = wrapper.querySelector('code');
            const code = codeEl.textContent;
            
            navigator.clipboard.writeText(code).then(() => {
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg>Copied!`;
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        document.addEventListener('click', (e) => {
            if (e.target.closest('.copy-btn')) {
                copyCode(e.target.closest('.copy-btn'));
            }
        });

        // =============================================
        // FOOTNOTE EXTENSION FOR MARKED.JS
        // =============================================

        const footnoteStorage = {
            footnotes: {},
            footnoteRefs: [],
            reset() {
                this.footnotes = {};
                this.footnoteRefs = [];
            }
        };

        const footnoteRefExtension = {
            name: 'footnoteRef',
            level: 'inline',
            start(src) {
                return src.match(/\[\^/)?.index;
            },
            tokenizer(src) {
                const match = /^\[\^([^\]]+)\](?!\:)/.exec(src);
                if (match) {
                    const id = match[1].trim();
                    if (!footnoteStorage.footnoteRefs.includes(id)) {
                        footnoteStorage.footnoteRefs.push(id);
                    }
                    return {
                        type: 'footnoteRef',
                        raw: match[0],
                        id: id,
                        refIndex: footnoteStorage.footnoteRefs.indexOf(id) + 1
                    };
                }
            },
            renderer(token) {
                return `<sup class="footnote-ref"><a href="#fn-${token.id}" id="fnref-${token.id}">[${token.refIndex}]</a></sup>`;
            }
        };

        const footnoteDefExtension = {
            name: 'footnoteDef',
            level: 'block',
            start(src) {
                return src.match(/^\[\^[^\]]+\]:/)?.index;
            },
            tokenizer(src) {
                const match = /^\[\^([^\]]+)\]:\s*(.+?)(?:\n|$)/.exec(src);
                if (match) {
                    const id = match[1].trim();
                    const content = match[2].trim();
                    footnoteStorage.footnotes[id] = content;
                    return {
                        type: 'footnoteDef',
                        raw: match[0],
                        id: id,
                        content: content
                    };
                }
            },
            renderer(token) {
                return '';
            }
        };

        function restoreMathInText(text, mathBlocks, inlineMaths) {
            let result = text;
            mathBlocks.forEach((math, i) => {
                result = result.replace(`%%MATHBLOCK${i}%%`, math);
            });
            inlineMaths.forEach((math, i) => {
                result = result.replace(`%%MATHINLINE${i}%%`, math);
            });
            return result;
        }

        function appendFootnotesSection(html, mathBlocks, inlineMaths) {
            const ids = footnoteStorage.footnoteRefs;
            if (ids.length === 0) return html;

            let footnotesHtml = '<section class="footnotes"><ol>';
            ids.forEach((id, index) => {
                let content = footnoteStorage.footnotes[id] || 'Footnote not defined';
                content = restoreMathInText(content, mathBlocks, inlineMaths);
                const parsedContent = marked.parseInline(content);
                footnotesHtml += `<li id="fn-${id}"><p>${parsedContent} <a href="#fnref-${id}" class="footnote-backref">‚Ü©</a></p></li>`;
            });
            footnotesHtml += '</ol></section>';

            return html + footnotesHtml;
        }

        // =============================================
        // MARKED.JS CONFIGURATION
        // =============================================

        marked.use({
            breaks: true,
            gfm: true,
            extensions: [footnoteRefExtension, footnoteDefExtension],
            renderer: {
                code({ text, lang, escaped }) {
                    const langClass = lang ? escapeHtml(lang.split(/\s/)[0]) : 'plaintext';
                    const langDisplay = lang ? lang.split(/\s/)[0] : 'Plain Text';
                    let highlighted;

                    if (lang && Prism.languages[lang]) {
                        try {
                            highlighted = Prism.highlight(text, Prism.languages[lang], lang);
                        } catch (e) {
                            console.error('Prism highlighting error:', e);
                            highlighted = escaped ? text : escapeHtml(text);
                        }
                    } else {
                        highlighted = escaped ? text : escapeHtml(text);
                    }

                    const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.666 3.888A2.25 2.25 0 0013.5 2.25h-3c-1.03 0-1.9.693-2.166 1.638m7.332 0c.055.194.084.4.084.612v0a.75.75 0 01-.75.75H9.75a.75.75 0 01-.75-.75v0c0-.212.03-.418.084-.612m7.332 0c.646.049 1.288.11 1.927.184 1.1.128 1.907 1.077 1.907 2.185V19.5a2.25 2.25 0 01-2.25 2.25H6.75A2.25 2.25 0 014.5 19.5V6.257c0-1.108.806-2.057 1.907-2.185a48.208 48.208 0 011.927-.184" /></svg>`;

                    return `<div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-lang">${escapeHtml(langDisplay)}</span>
                            <button class="copy-btn">${copyIcon}Copy</button>
                        </div>
                        <pre class="language-${langClass}"><code class="language-${langClass}">${highlighted}</code></pre>
                    </div>`;
                }
            }
        });

        function wrapTables(html) {
            return html
                .replace(/<table>/g, '<div class="table-wrapper"><table>')
                .replace(/<\/table>/g, '</table></div>');
        }

        // =============================================
        // DOM ELEMENT REFERENCES
        // =============================================

        const markdownInput = document.getElementById('markdown-input');
        const markdownOutput = document.getElementById('markdown-output');
        const directionIndicator = document.getElementById('direction-indicator');
        const directionStats = document.getElementById('direction-stats');
        const wordCountEl = document.getElementById('word-count');
        const charCountEl = document.getElementById('char-count');
        const syncScrollToggle = document.getElementById('sync-scroll-toggle');
        const downloadMdBtn = document.getElementById('download-md-btn');
        const downloadHtmlBtn = document.getElementById('download-html-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const clearStorageBtn = document.getElementById('clear-storage-btn');

        // =============================================
        // SYNC SCROLL FUNCTIONALITY
        // =============================================

        let isSyncScrollEnabled = true;
        let isEditorScrolling = false;
        let isPreviewScrolling = false;

        syncScrollToggle.addEventListener('change', (e) => {
            isSyncScrollEnabled = e.target.checked;
        });

        markdownInput.addEventListener('scroll', () => {
            if (!isSyncScrollEnabled || isPreviewScrolling) return;
            
            isEditorScrolling = true;
            
            const editorScrollHeight = markdownInput.scrollHeight - markdownInput.clientHeight;
            const previewScrollHeight = markdownOutput.scrollHeight - markdownOutput.clientHeight;
            
            if (editorScrollHeight > 0 && previewScrollHeight > 0) {
                const scrollPercentage = markdownInput.scrollTop / editorScrollHeight;
                markdownOutput.scrollTop = scrollPercentage * previewScrollHeight;
            }
            
            requestAnimationFrame(() => {
                isEditorScrolling = false;
            });
        });

        markdownOutput.addEventListener('scroll', () => {
            if (!isSyncScrollEnabled || isEditorScrolling) return;
            
            isPreviewScrolling = true;
            
            const editorScrollHeight = markdownInput.scrollHeight - markdownInput.clientHeight;
            const previewScrollHeight = markdownOutput.scrollHeight - markdownOutput.clientHeight;
            
            if (editorScrollHeight > 0 && previewScrollHeight > 0) {
                const scrollPercentage = markdownOutput.scrollTop / previewScrollHeight;
                markdownInput.scrollTop = scrollPercentage * editorScrollHeight;
            }
            
            requestAnimationFrame(() => {
                isPreviewScrolling = false;
            });
        });

        // =============================================
        // EXPORT FUNCTIONALITY
        // =============================================

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadMarkdown() {
            const content = markdownInput.value;
            const filename = 'document.md';
            downloadFile(content, filename, 'text/markdown;charset=utf-8');
        }

        // Complete CSS styles for HTML export
        const exportStyles = `
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            line-height: 1.8;
            color: #334155;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: #f8fafc;
        }
        /* RTL/LTR Direction Handling */
        [dir="rtl"] {
            direction: rtl;
            text-align: right;
        }
        [dir="ltr"] {
            direction: ltr;
            text-align: left;
        }
        /* Line Block Styling */
        .line-block {
            display: block;
        }
        .line-block[dir="rtl"] {
            direction: rtl;
            text-align: right;
        }
        .line-block[dir="ltr"] {
            direction: ltr;
            text-align: left;
        }
        ul[dir="rtl"], ol[dir="rtl"] {
            padding-left: 0;
            padding-right: 2em;
        }
        ul[dir="ltr"], ol[dir="ltr"] {
            padding-left: 2em;
            padding-right: 0;
        }
        blockquote[dir="rtl"] {
            border-left: none;
            border-right: 3px solid #cbd5e1;
            padding-right: 1em;
            padding-left: 0;
        }
        blockquote[dir="ltr"] {
            border-right: none;
            border-left: 3px solid #cbd5e1;
            padding-left: 1em;
            padding-right: 0;
        }
        /* Typography */
        h1 { font-size: 1.875em; font-weight: 700; margin: 0.67em 0; color: #0f172a; }
        h2 { font-size: 1.5em; font-weight: 600; margin: 0.83em 0; color: #1e293b; }
        h3 { font-size: 1.25em; font-weight: 600; margin: 1em 0; color: #334155; }
        h4 { font-size: 1.1em; font-weight: 600; margin: 1em 0; color: #475569; }
        p { margin-bottom: 1em; color: #475569; overflow-wrap: break-word; }
        strong { font-weight: 600; color: #1e293b; }
        em { font-style: italic; }
        /* Lists */
        ul, ol { margin-bottom: 1em; padding-left: 2em; }
        ul { list-style-type: disc; }
        ol { list-style-type: decimal; }
        li { margin-bottom: 0.25em; color: #475569; }
        /* Links */
        a { color: #2563eb; text-decoration: none; }
        a:hover { text-decoration: underline; }
        /* Inline Code */
        code:not([class*="language-"]) {
            background: #f1f5f9;
            padding: 0.15em 0.4em;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
            color: #0f172a;
            unicode-bidi: isolate;
            direction: ltr;
            display: inline-block;
            vertical-align: baseline;
            white-space: nowrap;
        }
        /* Code Block Wrapper */
        .code-block-wrapper {
            margin: 1em 0;
            border-radius: 8px;
            overflow: hidden;
            background: #1e293b;
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #0f172a;
            border-bottom: 1px solid #334155;
        }
        .code-lang {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: #94a3b8;
        }
        .copy-btn { display: none; }
        /* Code Blocks */
        pre {
            margin: 1em 0;
            border-radius: 8px;
            overflow-x: auto;
            background: #1e293b;
            padding: 1em;
            direction: ltr !important;
            text-align: left !important;
        }
        .code-block-wrapper pre {
            margin: 0 !important;
            border-radius: 0 !important;
        }
        pre code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
            line-height: 1.6;
            display: block;
            color: #e2e8f0;
            unicode-bidi: normal;
            white-space: pre;
        }
        /* Blockquotes */
        blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            background: #f8fafc;
            border-left: 3px solid #cbd5e1;
            color: #64748b;
            overflow-x: auto;
        }
        /* Horizontal Rules */
        hr { border: none; height: 1px; background: #e2e8f0; margin: 2em 0; }
        /* Tables */
        .table-wrapper { overflow-x: auto; margin: 1em 0; max-width: 100%; }
        table { width: max-content; min-width: 100%; border-collapse: collapse; }
        th, td { padding: 0.5em 1em; border: 1px solid #e2e8f0; text-align: left; white-space: nowrap; }
        th { background: #f8fafc; font-weight: 600; color: #334155; }
        td { background: white; }
        /* MathJax */
        mjx-container:not([display="true"]) {
            display: inline-block !important;
            overflow: visible !important;
            vertical-align: middle !important;
            margin: 0 2px !important;
        }
        mjx-container[display="true"] {
            display: block !important;
            margin: 1em auto !important;
            padding: 1em;
            background: #fffbeb;
            border-radius: 8px;
            border: 1px solid #fef3c7;
            text-align: center !important;
            direction: ltr !important;
        }
        .math-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            margin: 1em 0;
            max-width: 100%;
        }
        /* Footnotes */
        .footnotes {
            margin-top: 2em;
            padding-top: 1em;
            border-top: 1px solid #e2e8f0;
            font-size: 0.9em;
            color: #64748b;
        }
        .footnotes ol { padding-left: 1.5em; }
        .footnotes li { margin-bottom: 0.5em; }
        .footnotes li p { display: inline; margin: 0; }
        .footnote-ref { font-size: 0.75em; vertical-align: super; line-height: 0; }
        .footnote-ref a { text-decoration: none; color: #2563eb; padding: 0 2px; }
        .footnote-backref { text-decoration: none; margin-left: 0.5em; }
        /* BDI Elements */
        bdi { unicode-bidi: isolate; }
        `;

        function downloadHtml() {
            const previewContent = markdownOutput.innerHTML;
            
            // Create a complete HTML document with embedded styles
            const fullHtml = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exported Markdown</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            chtml: {
                mtextInheritFont: true,
                scale: 1
            }
        };
    <\/script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"><\/script>
    <style>
        ${exportStyles}
    </style>
</head>
<body>
    ${previewContent}
</body>
</html>`;

            downloadFile(fullHtml, 'document.html', 'text/html;charset=utf-8');
        }

        function downloadPdf() {
            // Disable button during export
            downloadPdfBtn.disabled = true;
            const originalText = downloadPdfBtn.innerHTML;
            downloadPdfBtn.innerHTML = `<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" style="animation: spin 1s linear infinite;"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99" /></svg> Generating...`;
            
            // Create a clone of the preview content for PDF
            const element = markdownOutput.cloneNode(true);
            
            // Create a temporary container with all styles
            const container = document.createElement('div');
            container.style.cssText = 'position: absolute; left: -9999px; top: 0; width: 800px;';
            
            // Add inline styles to the container
            const styleEl = document.createElement('style');
            styleEl.textContent = exportStyles;
            container.appendChild(styleEl);
            container.appendChild(element);
            document.body.appendChild(container);
            
            // Configure html2pdf options
            const opt = {
                margin: [15, 15, 15, 15],
                filename: 'document.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    letterRendering: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            // Generate PDF
            html2pdf().set(opt).from(element).save().then(() => {
                // Clean up
                document.body.removeChild(container);
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.innerHTML = originalText;
            }).catch((err) => {
                console.error('PDF generation failed:', err);
                document.body.removeChild(container);
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.innerHTML = originalText;
                alert('PDF generation failed. Please try again.');
            });
        }

        downloadMdBtn.addEventListener('click', downloadMarkdown);
        downloadHtmlBtn.addEventListener('click', downloadHtml);
        downloadPdfBtn.addEventListener('click', downloadPdf);

        // =============================================
        // CLEAR STORAGE FUNCTIONALITY
        // =============================================

        clearStorageBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear saved content? This will reload the sample content.')) {
                clearLocalStorage();
                markdownInput.value = sampleMarkdown;
                updatePreview();
                autoSaveText.textContent = 'Saved content cleared';
                autoSaveIndicator.classList.remove('saving', 'saved');
            }
        });

        // =============================================
        // RTL/LTR DIRECTION DETECTION
        // =============================================

        const PERSIAN_ARABIC_PATTERN = /[\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF]/g;
        const LATIN_PATTERN = /[A-Za-z\u00C0-\u024F]/g;

        function countCharacterTypes(text) {
            const cleanText = text
                .replace(/<[^>]*>/g, '')
                .replace(/\$\$[\s\S]*?\$\$/g, '')
                .replace(/\$[^$]+\$/g, '')
                .replace(/`[^`]+`/g, '')
                .replace(/```[\s\S]*?```/g, '')
                .replace(/https?:\/\/[^\s]+/g, '')
                .replace(/[0-9\s\p{P}\p{S}]/gu, '');

            const persianMatches = cleanText.match(PERSIAN_ARABIC_PATTERN) || [];
            const latinMatches = cleanText.match(LATIN_PATTERN) || [];

            return {
                persian: persianMatches.length,
                latin: latinMatches.length
            };
        }

        function getElementDirection(text) {
            const counts = countCharacterTypes(text);

            if (counts.persian === 0 && counts.latin === 0) {
                return 'ltr';
            }

            return counts.persian > counts.latin ? 'rtl' : 'ltr';
        }

        function processElementWithLineBreaks(el) {
            let rtl = 0, ltr = 0;
            
            const brs = el.querySelectorAll('br');
            
            if (brs.length === 0) {
                const text = el.textContent || '';
                const direction = getElementDirection(text);
                el.setAttribute('dir', direction);
                if (direction === 'rtl') rtl++; else ltr++;
                return { rtl, ltr };
            }
            
            const directBrs = Array.from(el.childNodes).filter(
                node => node.nodeType === Node.ELEMENT_NODE && node.tagName === 'BR'
            );
            
            if (directBrs.length === 0) {
                const text = el.textContent || '';
                const direction = getElementDirection(text);
                el.setAttribute('dir', direction);
                if (direction === 'rtl') rtl++; else ltr++;
                return { rtl, ltr };
            }
            
            const fragment = document.createDocumentFragment();
            let currentSpan = document.createElement('span');
            currentSpan.className = 'line-block';
            let currentText = '';
            
            Array.from(el.childNodes).forEach(node => {
                if (node.nodeType === Node.ELEMENT_NODE && node.tagName === 'BR') {
                    if (currentSpan.childNodes.length > 0 || currentText.trim()) {
                        const direction = getElementDirection(currentText);
                        currentSpan.setAttribute('dir', direction);
                        if (direction === 'rtl') rtl++; else ltr++;
                        fragment.appendChild(currentSpan);
                    } else {
                        const emptySpan = document.createElement('span');
                        emptySpan.className = 'line-block';
                        emptySpan.innerHTML = '&nbsp;';
                        fragment.appendChild(emptySpan);
                    }
                    currentSpan = document.createElement('span');
                    currentSpan.className = 'line-block';
                    currentText = '';
                } else {
                    const clone = node.cloneNode(true);
                    currentSpan.appendChild(clone);
                    currentText += node.textContent || '';
                }
            });
            
            if (currentSpan.childNodes.length > 0 || currentText.trim()) {
                const direction = getElementDirection(currentText);
                currentSpan.setAttribute('dir', direction);
                if (direction === 'rtl') rtl++; else ltr++;
                fragment.appendChild(currentSpan);
            }
            
            el.innerHTML = '';
            el.appendChild(fragment);
            el.removeAttribute('dir');
            
            return { rtl, ltr };
        }

        function applyPerBlockDirection(container) {
            let rtlCount = 0;
            let ltrCount = 0;

            const blockSelectors = [
                'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'li', 'blockquote', 'th', 'td'
            ];

            const lists = container.querySelectorAll('ul, ol');
            lists.forEach(list => {
                const listText = list.textContent || '';
                const direction = getElementDirection(listText);
                list.setAttribute('dir', direction);
                if (direction === 'rtl') rtlCount++; else ltrCount++;
            });

            blockSelectors.forEach(selector => {
                const elements = container.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el.closest('pre') || el.closest('code')) {
                        return;
                    }

                    const counts = processElementWithLineBreaks(el);
                    rtlCount += counts.rtl;
                    ltrCount += counts.ltr;
                });
            });

            return { rtlCount, ltrCount };
        }

        // =============================================
        // BIDIRECTIONAL TEXT ISOLATION
        // =============================================

        function isolateLatinInRTL(container) {
            const rtlElements = container.querySelectorAll('[dir="rtl"]');

            rtlElements.forEach(el => {
                if (el.tagName === 'PRE' || el.tagName === 'CODE') return;
                if (el.closest('pre') || el.closest('code')) return;

                const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
                const textNodes = [];
                let currentNode;

                while (currentNode = walker.nextNode()) {
                    const parent = currentNode.parentElement;
                    if (parent && !parent.closest('code, pre, bdi, mjx-container, mjx-math, mjx-mrow, mjx-mi, mjx-mo, mjx-mn, mjx-mtext, mjx-msup, mjx-msub, mjx-mfrac, mjx-msqrt, mjx-mroot, mjx-mtable, mjx-mtr, mjx-mtd, script, style')) {
                        textNodes.push(currentNode);
                    }
                }

                textNodes.forEach(textNode => {
                    const text = textNode.textContent;

                    const regex = /[^\s\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\(\)\[\]\{\}<>¬´¬ª‚Äπ‚Ä∫""''\"\'„Äå„Äç„Äé„Äè„Äê„Äë„Äî„Äï„Äà„Äâ„Ää„Äã‚ü®‚ü©‚ü™‚ü´‚¶É‚¶Ñ‚¶ó‚¶ò‚ÅΩ‚Åæ‚Çç‚Çé]*[A-Za-z][^\s\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\(\)\[\]\{\}<>¬´¬ª‚Äπ‚Ä∫""''\"\'„Äå„Äç„Äé„Äè„Äê„Äë„Äî„Äï„Äà„Äâ„Ää„Äã‚ü®‚ü©‚ü™‚ü´‚¶É‚¶Ñ‚¶ó‚¶ò‚ÅΩ‚Åæ‚Çç‚Çé]*(?:\s+[^\s\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\(\)\[\]\{\}<>¬´¬ª‚Äπ‚Ä∫""''\"\'„Äå„Äç„Äé„Äè„Äê„Äë„Äî„Äï„Äà„Äâ„Ää„Äã‚ü®‚ü©‚ü™‚ü´‚¶É‚¶Ñ‚¶ó‚¶ò‚ÅΩ‚Åæ‚Çç‚Çé]*[A-Za-z][^\s\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\(\)\[\]\{\}<>¬´¬ª‚Äπ‚Ä∫""''\"\'„Äå„Äç„Äé„Äè„Äê„Äë„Äî„Äï„Äà„Äâ„Ää„Äã‚ü®‚ü©‚ü™‚ü´‚¶É‚¶Ñ‚¶ó‚¶ò‚ÅΩ‚Åæ‚Çç‚Çé]*)*/g;

                    if (!regex.test(text)) return;
                    regex.lastIndex = 0;

                    const fragment = document.createDocumentFragment();
                    let lastIndex = 0;
                    let match;
                    let hasMatches = false;

                    while ((match = regex.exec(text)) !== null) {
                        hasMatches = true;

                        if (match.index > lastIndex) {
                            fragment.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
                        }

                        let matchedText = match[0];
                        let trailingPunct = '';

                        const trailingMatch = matchedText.match(/[.!?,;:]+$/);
                        if (trailingMatch) {
                            trailingPunct = trailingMatch[0];
                            matchedText = matchedText.slice(0, -trailingPunct.length);
                        }

                        if (matchedText) {
                            const bdi = document.createElement('bdi');
                            bdi.textContent = matchedText;
                            fragment.appendChild(bdi);
                        }

                        if (trailingPunct) {
                            fragment.appendChild(document.createTextNode(trailingPunct));
                        }

                        lastIndex = regex.lastIndex;
                    }

                    if (lastIndex < text.length) {
                        fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
                    }

                    if (hasMatches && textNode.parentNode) {
                        textNode.parentNode.replaceChild(fragment, textNode);
                    }
                });
            });
        }

        // =============================================
        // WRAP BLOCK MATH IN SCROLLABLE CONTAINER
        // =============================================

        function wrapBlockMath(container) {
            const blockMathContainers = container.querySelectorAll('mjx-container[display="true"]');
            blockMathContainers.forEach(mjx => {
                if (!mjx.parentElement.classList.contains('math-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'math-wrapper';
                    mjx.parentNode.insertBefore(wrapper, mjx);
                    wrapper.appendChild(mjx);
                }
            });
        }

        // =============================================
        // UI UPDATE FUNCTIONS
        // =============================================

        function updateDirectionIndicator(rtlCount, ltrCount) {
            const total = rtlCount + ltrCount;
            let badgeClass, label;

            if (total === 0) {
                badgeClass = 'ltr';
                label = 'LTR';
            } else if (rtlCount > 0 && ltrCount > 0) {
                badgeClass = 'mixed';
                label = 'Mixed';
            } else if (rtlCount > ltrCount) {
                badgeClass = 'rtl';
                label = 'RTL';
            } else {
                badgeClass = 'ltr';
                label = 'LTR';
            }

            directionIndicator.innerHTML = `<span class="status-badge ${badgeClass}">${label}</span>`;
            directionStats.textContent = `RTL: ${rtlCount} ¬∑ LTR: ${ltrCount}`;
        }

        function updateStats(text) {
            const chars = text.length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            wordCountEl.textContent = `${words} words`;
            charCountEl.textContent = `${chars} chars`;
        }

        // =============================================
        // MATH EXPRESSION HANDLING
        // =============================================

        function escapeMath(text) {
            const mathBlocks = [];
            const inlineMaths = [];

            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                mathBlocks.push(match);
                return `%%MATHBLOCK${mathBlocks.length - 1}%%`;
            });

            text = text.replace(/\$([^\$\n]+?)\$/g, (match, math) => {
                inlineMaths.push(match);
                return `%%MATHINLINE${inlineMaths.length - 1}%%`;
            });

            return { text, mathBlocks, inlineMaths };
        }

        function restoreMath(html, mathBlocks, inlineMaths) {
            mathBlocks.forEach((math, i) => {
                html = html.replace(`%%MATHBLOCK${i}%%`, math);
            });

            inlineMaths.forEach((math, i) => {
                html = html.replace(`%%MATHINLINE${i}%%`, math);
            });

            return html;
        }

        // =============================================
        // MAIN UPDATE FUNCTION
        // =============================================

        function updatePreview() {
            const rawMarkdown = markdownInput.value;

            updateStats(rawMarkdown);

            if (rawMarkdown.trim() === '') {
                markdownOutput.innerHTML = '<p class="text-slate-400 text-center italic">Your preview will appear here...</p>';
                updateDirectionIndicator(0, 0);
                return;
            }

            footnoteStorage.reset();

            const { text, mathBlocks, inlineMaths } = escapeMath(rawMarkdown);

            let html = marked.parse(text);

            html = restoreMath(html, mathBlocks, inlineMaths);

            html = wrapTables(html);

            html = appendFootnotesSection(html, mathBlocks, inlineMaths);

            // Sanitize the HTML output before rendering
            const sanitizedHtml = sanitizeHtml('<div class="markdown-inner">' + html + '</div>');

            markdownOutput.innerHTML = sanitizedHtml;

            const directionCounts = applyPerBlockDirection(markdownOutput);
            updateDirectionIndicator(directionCounts.rtlCount, directionCounts.ltrCount);

            Prism.highlightAllUnder(markdownOutput);

            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetClear([markdownOutput]);
                MathJax.typesetPromise([markdownOutput])
                    .then(() => {
                        wrapBlockMath(markdownOutput);
                        isolateLatinInRTL(markdownOutput);
                    })
                    .catch((err) => {
                        console.error('MathJax error:', err);
                        isolateLatinInRTL(markdownOutput);
                    });
            } else {
                isolateLatinInRTL(markdownOutput);
            }
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================

        const debouncedUpdate = debounce(updatePreview, 150);
        
        markdownInput.addEventListener('input', () => {
            debouncedUpdate();
            handleAutoSave();
        });
        
        markdownInput.addEventListener('paste', () => {
            setTimeout(() => {
                updatePreview();
                handleAutoSave();
            }, 0);
        });

        // =============================================
        // SAMPLE CONTENT
        // =============================================

        const sampleMarkdown = `# üöÄ Markdown Previewer Demo

Welcome to this **feature-rich** Markdown previewer! It supports *real-time preview*, syntax highlighting, LaTeX math, and **intelligent RTL/LTR detection**.

---

## üìê Mathematics

### Inline Math

The famous equation $E = mc^2$ revolutionized physics. The quadratic formula is $x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$.

### Block Equations

The Gaussian integral:

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

Euler's identity, often called the most beautiful equation:

$$e^{i\\pi} + 1 = 0$$

Maxwell's equations in differential form:

$$\\nabla \\cdot \\vec{E} = \\frac{\\rho}{\\varepsilon_0}, \\quad \\nabla \\times \\vec{B} = \\mu_0\\vec{J} + \\mu_0\\varepsilon_0\\frac{\\partial \\vec{E}}{\\partial t}$$

---

## üíª Code Examples

### JavaScript

\`\`\`javascript
const fibonacci = (n) => {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
};

console.log(fibonacci(10)); // 55
\`\`\`

### Python

\`\`\`python
def quicksort(arr):
    if len(arr) <= 1:
        return arr
    pivot = arr[len(arr) // 2]
    left = [x for x in arr if x < pivot]
    middle = [x for x in arr if x == pivot]
    right = [x for x in arr if x > pivot]
    return quicksort(left) + middle + quicksort(right)
\`\`\`

### Rust

\`\`\`rust
fn main() {
    let numbers: Vec<i32> = (1..=10).collect();
    let sum: i32 = numbers.iter().sum();
    println!("Sum: {}", sum);
}
\`\`\`

Inline code works too: Use \`npm install\` or \`pip install\` to manage packages.

---

## üåç Multilingual Support

### ÿ®ÿÆÿ¥ ŸÅÿßÿ±ÿ≥€å

ÿß€åŸÜ Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥⁄Øÿ± ÿßÿ≤ **ÿ≤ÿ®ÿßŸÜ ŸÅÿßÿ±ÿ≥€å** Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÖ€å‚Äå⁄©ŸÜÿØ. ŸÖÿπÿßÿØŸÑ€Ä ŸÖÿπÿ±ŸàŸÅ $E = mc^2$ ŸÅ€åÿ≤€å⁄© ÿ±ÿß ŸÖÿ™ÿ≠ŸàŸÑ ⁄©ÿ±ÿØ.

ŸÅÿ±ŸÖŸàŸÑ ŸÖÿ¥ÿ™ŸÇ:

$$\\frac{d}{dx}[f(x) \\cdot g(x)] = f'(x)g(x) + f(x)g'(x)$$

### ⁄©ÿØ ÿØÿ± ŸÖÿ™ŸÜ ŸÅÿßÿ±ÿ≥€å

ÿ®ÿ±ÿß€å ŸÜÿµÿ® Ÿæ⁄©€åÿ¨ ÿßÿ≤ ÿØÿ≥ÿ™Ÿàÿ± \`npm install package-name\` ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ.

ÿ≤ÿ®ÿßŸÜ‚ÄåŸáÿß€å ŸÖÿ≠ÿ®Ÿàÿ®: Python Ÿà JavaScript Ÿà Rust Ÿà Go.

### ŸÑ€åÿ≥ÿ™ ŸÅÿßÿ±ÿ≥€å

- ŸÖŸàÿ±ÿØ ÿßŸàŸÑ ÿ®ÿß **ŸÖÿ™ŸÜ Ÿæÿ±ÿ±ŸÜ⁄Ø**
- ŸÖŸàÿ±ÿØ ÿØŸàŸÖ ÿ®ÿß *ŸÖÿ™ŸÜ ⁄©ÿ¨*
- ŸÖŸàÿ±ÿØ ÿ≥ŸàŸÖ ÿ®ÿß \`⁄©ÿØ ÿØÿ±ŸàŸÜ‚ÄåÿÆÿ∑€å\`
- ŸÖŸàÿ±ÿØ ⁄ÜŸáÿßÿ±ŸÖ ÿ®ÿß ŸÅÿ±ŸÖŸàŸÑ $x^2 + y^2 = r^2$

### ÿ™ÿ≥ÿ™ ÿÆÿ∑ ÿ®Ÿá ÿÆÿ∑
ÿß€åŸÜ ÿÆÿ∑ ŸÅÿßÿ±ÿ≥€å ÿßÿ≥ÿ™
This line is English
ÿß€åŸÜ ŸáŸÖ ŸÅÿßÿ±ÿ≥€å
And this is English again

---

## üìã Tables

| Language | Paradigm | Year | Creator |
|----------|----------|------|---------|
| Python | Multi-paradigm | 1991 | Guido van Rossum |
| JavaScript | Multi-paradigm | 1995 | Brendan Eich |
| Rust | Systems | 2010 | Graydon Hoare |
| Go | Concurrent | 2009 | Robert Griesemer |

---

## üìù Lists

### Ordered List

1. First item with **bold text**
2. Second item with \`inline code\`
3. Third item with math: $\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}$
4. Fourth item with a [link](https://example.com)

### Unordered List

- Item with *italics*
- Item with ~~strikethrough~~
- Nested items:
  - Sub-item one
  - Sub-item two
  - Sub-item three

---

## üìö Footnotes

The theory of general relativity[^1] describes gravity as a geometric property of spacetime.

Quantum mechanics[^2] revolutionized our understanding of atomic and subatomic particles.

The equation $E=mc^2$ is famous[^3].

[^1]: Published by Albert Einstein in 1915.
[^2]: Developed in the early 20th century by Planck, Bohr, Heisenberg, and Schr√∂dinger.
[^3]: This shows that mass and energy are equivalent, where $E$ is energy, $m$ is mass, and $c$ is the speed of light.

---

## üí¨ Blockquotes

> "The only way to do great work is to love what you do."
> ‚Äî *Steve Jobs*

> üìå **ŸÜ⁄©ÿ™Ÿá ŸÖŸáŸÖ:** ÿß€åŸÜ Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥⁄Øÿ± ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿÆŸàÿØ⁄©ÿßÿ± ÿ¨Ÿáÿ™ ŸÖÿ™ŸÜ ÿ±ÿß ÿ™ÿ¥ÿÆ€åÿµ ŸÖ€å‚ÄåÿØŸáÿØ.

> \`\`\`
> Code blocks inside blockquotes also work!
> \`\`\`

---

## üé® Text Formatting

- **Bold text** for emphasis
- *Italic text* for subtle emphasis
- ***Bold and italic*** combined
- ~~Strikethrough~~ for deleted text
- \`Inline code\` for technical terms

---

*Built with Marked.js, MathJax, and Prism.js* ‚ú®`;

        // =============================================
        // INITIALIZATION
        // =============================================

        function initialize() {
            // Try to load saved content from localStorage
            const { content, timestamp } = loadFromLocalStorage();
            
            if (content && content.trim() !== '') {
                markdownInput.value = content;
                if (timestamp) {
                    const savedDate = new Date(parseInt(timestamp));
                    autoSaveText.textContent = `Last saved: ${savedDate.toLocaleString()}`;
                    autoSaveIndicator.classList.add('saved');
                }
            } else {
                // Use sample content if no saved content
                markdownInput.value = sampleMarkdown;
            }
            
            // Initial preview update
            updatePreview();
        }

        // Initialize when DOM is ready
        if (document.readyState === 'complete') {
            setTimeout(initialize, 500);
        } else {
            window.addEventListener('load', () => setTimeout(initialize, 500));
        }
    </script>
</body>
</html>
