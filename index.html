<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Previewer</title>
    <meta name="description" content="Smart RTL-aware Markdown previewer with MathJax, Prism, and Tailwind-like styles.">
    
    <!-- =============================================
         EXTERNAL DEPENDENCIES
         ============================================= -->
    
    <!-- Tailwind CSS - Utility-first CSS framework -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    
    <!-- Marked.js - Fast Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Prism.js - Syntax highlighting for code blocks -->
    <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <!-- MathJax - LaTeX math rendering with RTL language support -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            },
            chtml: {
                mtextInheritFont: true,
                scale: 1
            },
            svg: {
                mtextInheritFont: true,
                scale: 1
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    window.mathJaxReady = true;
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Google Fonts - Vazirmatn for Persian, Inter for Latin, JetBrains Mono for code -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- =============================================
         STYLES
         ============================================= -->
    <style>
        /* ----- CSS Variables ----- */
        :root {
            --border-radius: 12px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Vazirmatn', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }

        /* ----- Card Styling ----- */
        .card {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-sm);
            border-radius: var(--border-radius);
        }

        /* ----- Editor Textarea ----- */
        .editor-textarea {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            line-height: 1.7;
            resize: none;
            background: #1e293b;
            color: #e2e8f0;
            border: none;
        }

        .editor-textarea::placeholder {
            color: #64748b;
        }

        .editor-textarea:focus {
            outline: none;
        }

        /* ----- Preview Container ----- */
        .preview-container {
            overflow-y: auto;
            overflow-x: hidden;
        }

        .markdown-inner {
            width: 100%;
            max-width: 100%;
        }

        /* ----- Markdown Output Base Styles ----- */
        .markdown-body {
            font-family: 'Vazirmatn', 'Inter', sans-serif;
            line-height: 1.8;
            color: #334155;
        }

        /* ----- RTL/LTR Direction Handling ----- */
        .markdown-body [dir="rtl"] {
            direction: rtl;
            text-align: right;
        }

        .markdown-body [dir="ltr"] {
            direction: ltr;
            text-align: left;
        }

        .markdown-body ul[dir="rtl"],
        .markdown-body ol[dir="rtl"] {
            padding-left: 0;
            padding-right: 2em;
        }

        .markdown-body ul[dir="ltr"],
        .markdown-body ol[dir="ltr"] {
            padding-left: 2em;
            padding-right: 0;
        }

        .markdown-body blockquote[dir="rtl"] {
            border-left: none;
            border-right: 3px solid #cbd5e1;
            padding-right: 1em;
            padding-left: 0;
        }

        .markdown-body blockquote[dir="ltr"] {
            border-right: none;
            border-left: 3px solid #cbd5e1;
            padding-left: 1em;
            padding-right: 0;
        }

        /* ----- Typography ----- */
        .markdown-body h1 {
            font-size: 1.875em;
            font-weight: 700;
            margin: 0.67em 0;
            color: #0f172a;
        }

        .markdown-body h2 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 0.83em 0;
            color: #1e293b;
        }

        .markdown-body h3 {
            font-size: 1.25em;
            font-weight: 600;
            margin: 1em 0;
            color: #334155;
        }

        .markdown-body h4 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 1em 0;
            color: #475569;
        }

        .markdown-body p {
            margin-bottom: 1em;
            color: #475569;
            overflow-wrap: break-word;
        }

        .markdown-body strong {
            font-weight: 600;
            color: #1e293b;
        }

        .markdown-body em {
            font-style: italic;
        }

        /* ----- Lists ----- */
        .markdown-body ul,
        .markdown-body ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }

        .markdown-body ul {
            list-style-type: disc;
        }

        .markdown-body ol {
            list-style-type: decimal;
        }

        .markdown-body li {
            margin-bottom: 0.25em;
            color: #475569;
        }

        /* ----- Links ----- */
        .markdown-body a {
            color: #2563eb;
            text-decoration: none;
        }

        .markdown-body a:hover {
            text-decoration: underline;
        }

        /* ----- Inline Code ----- */
        .markdown-body code:not([class*="language-"]) {
            background: #f1f5f9;
            padding: 0.15em 0.4em;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
            color: #0f172a;
            unicode-bidi: isolate;
            direction: ltr;
            display: inline-block;
            vertical-align: baseline;
            white-space: nowrap;
        }

        /* ----- Code Blocks ----- */
        .markdown-body pre {
            margin: 1em 0;
            border-radius: 8px;
            overflow-x: auto;
            overflow-y: hidden;
            direction: ltr !important;
            text-align: left !important;
        }

        .markdown-body pre code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
            line-height: 1.6;
            display: block;
            unicode-bidi: normal;
            white-space: pre;
        }

        /* ----- Blockquotes ----- */
        .markdown-body blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            background: #f8fafc;
            border-left: 3px solid #cbd5e1;
            color: #64748b;
            overflow-x: auto;
        }

        /* ----- Horizontal Rules ----- */
        .markdown-body hr {
            border: none;
            height: 1px;
            background: #e2e8f0;
            margin: 2em 0;
        }

        /* ----- Tables ----- */
        .markdown-body .table-wrapper {
            overflow-x: auto;
            margin: 1em 0;
            max-width: 100%;
        }

        .markdown-body table {
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
        }

        .markdown-body th,
        .markdown-body td {
            padding: 0.5em 1em;
            border: 1px solid #e2e8f0;
            text-align: left;
            white-space: nowrap;
        }

        .markdown-body th {
            background: #f8fafc;
            font-weight: 600;
            color: #334155;
        }

        .markdown-body td {
            background: white;
        }

        /* ----- MathJax Inline ----- */
        mjx-container:not([display="true"]) {
            display: inline-block !important;
            overflow: visible !important;
            vertical-align: middle !important;
            margin: 0 2px !important;
            padding: 0 !important;
            max-width: none !important;
        }

        /* ----- MathJax Block/Display ----- */
        .math-wrapper {
            overflow-x: auto;
            overflow-y: hidden;
            margin: 1em 0;
            max-width: 100%;
        }

        mjx-container[display="true"] {
            display: block !important;
            margin: 0 auto !important;
            padding: 1em;
            background: #fffbeb;
            border-radius: 8px;
            border: 1px solid #fef3c7;
            text-align: center !important;
            direction: ltr !important;
            width: max-content;
            min-width: 100%;
        }

        mjx-mtext {
            font-family: 'Vazirmatn', 'Inter', sans-serif !important;
        }

        /* ----- Footnotes ----- */
        .markdown-body .footnotes {
            margin-top: 2em;
            padding-top: 1em;
            border-top: 1px solid #e2e8f0;
            font-size: 0.9em;
            color: #64748b;
        }

        .markdown-body .footnotes ol {
            padding-left: 1.5em;
        }

        .markdown-body .footnotes li {
            margin-bottom: 0.5em;
        }

        .markdown-body .footnotes li p {
            display: inline;
            margin: 0;
        }

        .markdown-body .footnote-ref {
            font-size: 0.75em;
            vertical-align: super;
            line-height: 0;
        }

        .markdown-body .footnote-ref a {
            text-decoration: none;
            color: #2563eb;
            padding: 0 2px;
        }

        .markdown-body .footnote-ref a:hover {
            text-decoration: underline;
        }

        .markdown-body .footnote-backref {
            text-decoration: none;
            margin-left: 0.5em;
        }

        /* ----- BDI Elements ----- */
        .markdown-body bdi {
            unicode-bidi: isolate;
        }

        /* ----- Scrollbar Styling ----- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .editor-textarea::-webkit-scrollbar-track,
        pre::-webkit-scrollbar-track {
            background: #334155;
        }

        .editor-textarea::-webkit-scrollbar-thumb,
        pre::-webkit-scrollbar-thumb {
            background: #64748b;
        }

        /* ----- Panel Header ----- */
        .panel-header {
            display: flex;
            gap: 6px;
            padding: 10px 14px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }

        .panel-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .panel-dot.red { background: #f87171; }
        .panel-dot.yellow { background: #fbbf24; }
        .panel-dot.green { background: #4ade80; }

        /* ----- Status Badge ----- */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .status-badge.mixed { background: #f1f5f9; color: #475569; }
        .status-badge.rtl { background: #fef3c7; color: #92400e; }
        .status-badge.ltr { background: #dbeafe; color: #1e40af; }

        /* ----- Stats Display ----- */
        .stats-text {
            font-size: 12px;
            color: #64748b;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- =============================================
         HEADER
         ============================================= -->
    <header class="bg-white border-b border-slate-200 py-4">
        <div class="container mx-auto px-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-slate-100 rounded-lg">
                        <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-slate-800">Markdown Previewer</h1>
                        <p class="text-xs text-slate-500">MathJax ‚Ä¢ Syntax Highlighting ‚Ä¢ Smart RTL</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 text-xs text-slate-500">
                    <span>üìù Markdown</span>
                    <span>üî¢ LaTeX</span>
                    <span>üîÑ RTL/LTR</span>
                </div>
            </div>
        </div>
    </header>

    <!-- =============================================
         MAIN CONTENT - Editor and Preview Panels
         ============================================= -->
    <main class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            
            <!-- Editor Panel -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium text-slate-600">Editor</span>
                    <div class="stats-text" id="stats">
                        <span id="word-count">0 words</span> ¬∑ <span id="char-count">0 chars</span>
                    </div>
                </div>
                
                <div class="card overflow-hidden flex-1 flex flex-col">
                    <div class="panel-header">
                        <div class="panel-dot red"></div>
                        <div class="panel-dot yellow"></div>
                        <div class="panel-dot green"></div>
                        <span class="text-slate-400 text-xs ml-3 font-mono">document.md</span>
                    </div>
                    <textarea
                        id="markdown-input"
                        class="editor-textarea w-full flex-1 p-4 min-h-[550px]"
                        placeholder="Start typing Markdown here..."
                        spellcheck="false"
                    ></textarea>
                </div>
            </div>

            <!-- Preview Panel -->
            <div class="flex flex-col">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-medium text-slate-600">Preview</span>
                    <div class="flex items-center gap-2">
                        <span class="stats-text" id="direction-stats">RTL: 0 ¬∑ LTR: 0</span>
                        <div id="direction-indicator">
                            <span class="status-badge ltr">LTR</span>
                        </div>
                    </div>
                </div>
                
                <div class="card overflow-hidden flex-1 flex flex-col">
                    <div class="flex items-center gap-2 px-4 py-2.5 bg-slate-50 border-b border-slate-200">
                        <div class="flex gap-1.5">
                            <div class="w-2.5 h-2.5 rounded-full bg-rose-400"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-amber-400"></div>
                            <div class="w-2.5 h-2.5 rounded-full bg-emerald-400"></div>
                        </div>
                        <span class="text-slate-400 text-xs ml-2 font-mono">preview.html</span>
                    </div>
                    <div
                        id="markdown-output"
                        class="markdown-body preview-container p-6 min-h-[550px] flex-1"
                    >
                        <p class="text-slate-400 text-center italic">Your preview will appear here...</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- =============================================
         FOOTER
         ============================================= -->
    <footer class="text-center py-4 text-slate-400 text-xs border-t border-slate-100">
        <p>Marked.js ¬∑ MathJax ¬∑ Prism.js</p>
    </footer>

    <!-- =============================================
         JAVASCRIPT
         ============================================= -->
    <script>
        // =============================================
        // UTILITY FUNCTIONS
        // =============================================

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // =============================================
        // FOOTNOTE EXTENSION FOR MARKED.JS
        // =============================================

        const footnoteStorage = {
            footnotes: {},
            footnoteRefs: [],
            reset() {
                this.footnotes = {};
                this.footnoteRefs = [];
            }
        };

        const footnoteRefExtension = {
            name: 'footnoteRef',
            level: 'inline',
            start(src) {
                return src.match(/\[\^/)?.index;
            },
            tokenizer(src) {
                const match = /^\[\^([^\]]+)\](?!\:)/.exec(src);
                if (match) {
                    const id = match[1].trim();
                    if (!footnoteStorage.footnoteRefs.includes(id)) {
                        footnoteStorage.footnoteRefs.push(id);
                    }
                    return {
                        type: 'footnoteRef',
                        raw: match[0],
                        id: id,
                        refIndex: footnoteStorage.footnoteRefs.indexOf(id) + 1
                    };
                }
            },
            renderer(token) {
                return `<sup class="footnote-ref"><a href="#fn-${token.id}" id="fnref-${token.id}">[${token.refIndex}]</a></sup>`;
            }
        };

        const footnoteDefExtension = {
            name: 'footnoteDef',
            level: 'block',
            start(src) {
                return src.match(/^\[\^[^\]]+\]:/)?.index;
            },
            tokenizer(src) {
                const match = /^\[\^([^\]]+)\]:\s*(.+?)(?:\n|$)/.exec(src);
                if (match) {
                    const id = match[1].trim();
                    const content = match[2].trim();
                    footnoteStorage.footnotes[id] = content;
                    return {
                        type: 'footnoteDef',
                        raw: match[0],
                        id: id,
                        content: content
                    };
                }
            },
            renderer(token) {
                return '';
            }
        };

        function appendFootnotesSection(html) {
            const ids = footnoteStorage.footnoteRefs;
            if (ids.length === 0) return html;

            let footnotesHtml = '<section class="footnotes"><ol>';
            ids.forEach((id, index) => {
                const content = footnoteStorage.footnotes[id] || 'Footnote not defined';
                const parsedContent = marked.parseInline(content);
                footnotesHtml += `<li id="fn-${id}"><p>${parsedContent} <a href="#fnref-${id}" class="footnote-backref">‚Ü©</a></p></li>`;
            });
            footnotesHtml += '</ol></section>';

            return html + footnotesHtml;
        }

        // =============================================
        // MARKED.JS CONFIGURATION
        // =============================================

        marked.use({
            breaks: true,
            gfm: true,
            extensions: [footnoteRefExtension, footnoteDefExtension],
            renderer: {
                code({ text, lang, escaped }) {
                    const langClass = lang ? escapeHtml(lang.split(/\s/)[0]) : 'plaintext';
                    let highlighted;

                    if (lang && Prism.languages[lang]) {
                        try {
                            highlighted = Prism.highlight(text, Prism.languages[lang], lang);
                        } catch (e) {
                            console.error('Prism highlighting error:', e);
                            highlighted = escaped ? text : escapeHtml(text);
                        }
                    } else {
                        highlighted = escaped ? text : escapeHtml(text);
                    }

                    return `<pre class="language-${langClass}"><code class="language-${langClass}">${highlighted}</code></pre>`;
                }
            }
        });

        function wrapTables(html) {
            return html
                .replace(/<table>/g, '<div class="table-wrapper"><table>')
                .replace(/<\/table>/g, '</table></div>');
        }

        // =============================================
        // DOM ELEMENT REFERENCES
        // =============================================

        const markdownInput = document.getElementById('markdown-input');
        const markdownOutput = document.getElementById('markdown-output');
        const directionIndicator = document.getElementById('direction-indicator');
        const directionStats = document.getElementById('direction-stats');
        const wordCountEl = document.getElementById('word-count');
        const charCountEl = document.getElementById('char-count');

        // =============================================
        // RTL/LTR DIRECTION DETECTION
        // =============================================

        const PERSIAN_ARABIC_PATTERN = /[\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF]/g;
        const LATIN_PATTERN = /[A-Za-z\u00C0-\u024F]/g;

        function countCharacterTypes(text) {
            const cleanText = text
                .replace(/<[^>]*>/g, '')
                .replace(/\$\$[\s\S]*?\$\$/g, '')
                .replace(/\$[^$]+\$/g, '')
                .replace(/`[^`]+`/g, '')
                .replace(/```[\s\S]*?```/g, '')
                .replace(/https?:\/\/[^\s]+/g, '')
                .replace(/[0-9\s\p{P}\p{S}]/gu, '');

            const persianMatches = cleanText.match(PERSIAN_ARABIC_PATTERN) || [];
            const latinMatches = cleanText.match(LATIN_PATTERN) || [];

            return {
                persian: persianMatches.length,
                latin: latinMatches.length
            };
        }

        function getElementDirection(text) {
            const counts = countCharacterTypes(text);

            if (counts.persian === 0 && counts.latin === 0) {
                return 'ltr';
            }

            return counts.persian > counts.latin ? 'rtl' : 'ltr';
        }

        function applyPerBlockDirection(container) {
            let rtlCount = 0;
            let ltrCount = 0;

            const blockSelectors = [
                'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'li', 'blockquote', 'th', 'td'
            ];

            const lists = container.querySelectorAll('ul, ol');
            lists.forEach(list => {
                const listText = list.textContent || '';
                const direction = getElementDirection(listText);
                list.setAttribute('dir', direction);
                if (direction === 'rtl') rtlCount++; else ltrCount++;
            });

            blockSelectors.forEach(selector => {
                const elements = container.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el.closest('pre') || el.closest('code')) {
                        return;
                    }

                    const text = el.textContent || '';
                    const direction = getElementDirection(text);

                    el.setAttribute('dir', direction);

                    if (direction === 'rtl') {
                        rtlCount++;
                    } else {
                        ltrCount++;
                    }
                });
            });

            return { rtlCount, ltrCount };
        }

        // =============================================
        // BIDIRECTIONAL TEXT ISOLATION
        // =============================================

        function isolateLatinInRTL(container) {
            const rtlElements = container.querySelectorAll('[dir="rtl"]');

            rtlElements.forEach(el => {
                if (el.tagName === 'PRE' || el.tagName === 'CODE') return;
                if (el.closest('pre') || el.closest('code')) return;

                const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
                const textNodes = [];
                let currentNode;

                while (currentNode = walker.nextNode()) {
                    const parent = currentNode.parentElement;
                    if (parent && !parent.closest('code, pre, bdi, mjx-container, mjx-math, mjx-mrow, mjx-mi, mjx-mo, mjx-mn, mjx-mtext, mjx-msup, mjx-msub, mjx-mfrac, mjx-msqrt, mjx-mroot, mjx-mtable, mjx-mtr, mjx-mtd, script, style')) {
                        textNodes.push(currentNode);
                    }
                }

                textNodes.forEach(textNode => {
                    const text = textNode.textContent;

                    const regex = /[^\s\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\(\)\[\]\{\}<>¬´¬ª‚Äπ‚Ä∫""''\"\'„Äå„Äç„Äé„Äè„Äê„Äë„Äî„Äï„Äà„Äâ„Ää„Äã‚ü®‚ü©‚ü™‚ü´‚¶É‚¶Ñ‚¶ó‚¶ò‚ÅΩ‚Åæ‚Çç‚Çé]*[A-Za-z][^\s\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\(\)\[\]\{\}<>¬´¬ª‚Äπ‚Ä∫""''\"\'„Äå„Äç„Äé„Äè„Äê„Äë„Äî„Äï„Äà„Äâ„Ää„Äã‚ü®‚ü©‚ü™‚ü´‚¶É‚¶Ñ‚¶ó‚¶ò‚ÅΩ‚Åæ‚Çç‚Çé]*(?:\s+[^\s\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\(\)\[\]\{\}<>¬´¬ª‚Äπ‚Ä∫""''\"\'„Äå„Äç„Äé„Äè„Äê„Äë„Äî„Äï„Äà„Äâ„Ää„Äã‚ü®‚ü©‚ü™‚ü´‚¶É‚¶Ñ‚¶ó‚¶ò‚ÅΩ‚Åæ‚Çç‚Çé]*[A-Za-z][^\s\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF\(\)\[\]\{\}<>¬´¬ª‚Äπ‚Ä∫""''\"\'„Äå„Äç„Äé„Äè„Äê„Äë„Äî„Äï„Äà„Äâ„Ää„Äã‚ü®‚ü©‚ü™‚ü´‚¶É‚¶Ñ‚¶ó‚¶ò‚ÅΩ‚Åæ‚Çç‚Çé]*)*/g;

                    if (!regex.test(text)) return;
                    regex.lastIndex = 0;

                    const fragment = document.createDocumentFragment();
                    let lastIndex = 0;
                    let match;
                    let hasMatches = false;

                    while ((match = regex.exec(text)) !== null) {
                        hasMatches = true;

                        if (match.index > lastIndex) {
                            fragment.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
                        }

                        let matchedText = match[0];
                        let trailingPunct = '';

                        const trailingMatch = matchedText.match(/[.!?,;:]+$/);
                        if (trailingMatch) {
                            trailingPunct = trailingMatch[0];
                            matchedText = matchedText.slice(0, -trailingPunct.length);
                        }

                        if (matchedText) {
                            const bdi = document.createElement('bdi');
                            bdi.textContent = matchedText;
                            fragment.appendChild(bdi);
                        }

                        if (trailingPunct) {
                            fragment.appendChild(document.createTextNode(trailingPunct));
                        }

                        lastIndex = regex.lastIndex;
                    }

                    if (lastIndex < text.length) {
                        fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
                    }

                    if (hasMatches && textNode.parentNode) {
                        textNode.parentNode.replaceChild(fragment, textNode);
                    }
                });
            });
        }

        // =============================================
        // WRAP BLOCK MATH IN SCROLLABLE CONTAINER
        // =============================================

        function wrapBlockMath(container) {
            const blockMathContainers = container.querySelectorAll('mjx-container[display="true"]');
            blockMathContainers.forEach(mjx => {
                if (!mjx.parentElement.classList.contains('math-wrapper')) {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'math-wrapper';
                    mjx.parentNode.insertBefore(wrapper, mjx);
                    wrapper.appendChild(mjx);
                }
            });
        }

        // =============================================
        // UI UPDATE FUNCTIONS
        // =============================================

        function updateDirectionIndicator(rtlCount, ltrCount) {
            const total = rtlCount + ltrCount;
            let badgeClass, label;

            if (total === 0) {
                badgeClass = 'ltr';
                label = 'LTR';
            } else if (rtlCount > 0 && ltrCount > 0) {
                badgeClass = 'mixed';
                label = 'Mixed';
            } else if (rtlCount > ltrCount) {
                badgeClass = 'rtl';
                label = 'RTL';
            } else {
                badgeClass = 'ltr';
                label = 'LTR';
            }

            directionIndicator.innerHTML = `<span class="status-badge ${badgeClass}">${label}</span>`;
            directionStats.textContent = `RTL: ${rtlCount} ¬∑ LTR: ${ltrCount}`;
        }

        function updateStats(text) {
            const chars = text.length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            wordCountEl.textContent = `${words} words`;
            charCountEl.textContent = `${chars} chars`;
        }

        // =============================================
        // MATH EXPRESSION HANDLING
        // =============================================

        function escapeMath(text) {
            const mathBlocks = [];
            const inlineMaths = [];

            text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                mathBlocks.push(match);
                return `%%MATHBLOCK${mathBlocks.length - 1}%%`;
            });

            text = text.replace(/\$([^\$\n]+?)\$/g, (match, math) => {
                inlineMaths.push(match);
                return `%%MATHINLINE${inlineMaths.length - 1}%%`;
            });

            return { text, mathBlocks, inlineMaths };
        }

        function restoreMath(html, mathBlocks, inlineMaths) {
            mathBlocks.forEach((math, i) => {
                html = html.replace(`%%MATHBLOCK${i}%%`, math);
            });

            inlineMaths.forEach((math, i) => {
                html = html.replace(`%%MATHINLINE${i}%%`, math);
            });

            return html;
        }

        // =============================================
        // MAIN UPDATE FUNCTION
        // =============================================

        function updatePreview() {
            const rawMarkdown = markdownInput.value;

            updateStats(rawMarkdown);

            if (rawMarkdown.trim() === '') {
                markdownOutput.innerHTML = '<p class="text-slate-400 text-center italic">Your preview will appear here...</p>';
                updateDirectionIndicator(0, 0);
                return;
            }

            footnoteStorage.reset();

            const { text, mathBlocks, inlineMaths } = escapeMath(rawMarkdown);

            let html = marked.parse(text);

            html = restoreMath(html, mathBlocks, inlineMaths);

            html = wrapTables(html);

            html = appendFootnotesSection(html);

            markdownOutput.innerHTML = '<div class="markdown-inner">' + html + '</div>';

            const directionCounts = applyPerBlockDirection(markdownOutput);
            updateDirectionIndicator(directionCounts.rtlCount, directionCounts.ltrCount);

            Prism.highlightAllUnder(markdownOutput);

            if (window.MathJax && window.MathJax.typesetPromise) {
                MathJax.typesetClear([markdownOutput]);
                MathJax.typesetPromise([markdownOutput])
                    .then(() => {
                        wrapBlockMath(markdownOutput);
                        isolateLatinInRTL(markdownOutput);
                    })
                    .catch((err) => {
                        console.error('MathJax error:', err);
                        isolateLatinInRTL(markdownOutput);
                    });
            } else {
                isolateLatinInRTL(markdownOutput);
            }
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================

        const debouncedUpdate = debounce(updatePreview, 150);
        markdownInput.addEventListener('input', debouncedUpdate);
        markdownInput.addEventListener('paste', () => setTimeout(updatePreview, 0));

        // =============================================
        // SAMPLE CONTENT
        // =============================================

        const sampleMarkdown = `# üöÄ Markdown Previewer Demo

Welcome to this **feature-rich** Markdown previewer! It supports *real-time preview*, syntax highlighting, LaTeX math, and **intelligent RTL/LTR detection**.

---

## üìê Mathematics

### Inline Math

The famous equation $E = mc^2$ revolutionized physics. The quadratic formula is $x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$.

### Block Equations

The Gaussian integral:

$$\\int_{-\\infty}^{\\infty} e^{-x^2} dx = \\sqrt{\\pi}$$

Euler's identity, often called the most beautiful equation:

$$e^{i\\pi} + 1 = 0$$

Maxwell's equations in differential form:

$$\\nabla \\cdot \\vec{E} = \\frac{\\rho}{\\varepsilon_0}, \\quad \\nabla \\times \\vec{B} = \\mu_0\\vec{J} + \\mu_0\\varepsilon_0\\frac{\\partial \\vec{E}}{\\partial t}$$

---

## üíª Code Examples

### JavaScript

\`\`\`javascript
const fibonacci = (n) => {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
};

console.log(fibonacci(10)); // 55
\`\`\`

### Python

\`\`\`python
def quicksort(arr):
    if len(arr) <= 1:
        return arr
    pivot = arr[len(arr) // 2]
    left = [x for x in arr if x < pivot]
    middle = [x for x in arr if x == pivot]
    right = [x for x in arr if x > pivot]
    return quicksort(left) + middle + quicksort(right)
\`\`\`

### Rust

\`\`\`rust
fn main() {
    let numbers: Vec<i32> = (1..=10).collect();
    let sum: i32 = numbers.iter().sum();
    println!("Sum: {}", sum);
}
\`\`\`

Inline code works too: Use \`npm install\` or \`pip install\` to manage packages.

---

## üåç Multilingual Support

### ÿ®ÿÆÿ¥ ŸÅÿßÿ±ÿ≥€å

ÿß€åŸÜ Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥⁄Øÿ± ÿßÿ≤ **ÿ≤ÿ®ÿßŸÜ ŸÅÿßÿ±ÿ≥€å** Ÿæÿ¥ÿ™€åÿ®ÿßŸÜ€å ŸÖ€å‚Äå⁄©ŸÜÿØ. ŸÖÿπÿßÿØŸÑ€Ä ŸÖÿπÿ±ŸàŸÅ $E = mc^2$ ŸÅ€åÿ≤€å⁄© ÿ±ÿß ŸÖÿ™ÿ≠ŸàŸÑ ⁄©ÿ±ÿØ.

ŸÅÿ±ŸÖŸàŸÑ ŸÖÿ¥ÿ™ŸÇ:

$$\\frac{d}{dx}[f(x) \\cdot g(x)] = f'(x)g(x) + f(x)g'(x)$$

### ⁄©ÿØ ÿØÿ± ŸÖÿ™ŸÜ ŸÅÿßÿ±ÿ≥€å

ÿ®ÿ±ÿß€å ŸÜÿµÿ® Ÿæ⁄©€åÿ¨ ÿßÿ≤ ÿØÿ≥ÿ™Ÿàÿ± \`npm install package-name\` ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ€åÿØ.

ÿ≤ÿ®ÿßŸÜ‚ÄåŸáÿß€å ŸÖÿ≠ÿ®Ÿàÿ®: Python Ÿà JavaScript Ÿà Rust Ÿà Go.

### ŸÑ€åÿ≥ÿ™ ŸÅÿßÿ±ÿ≥€å

- ŸÖŸàÿ±ÿØ ÿßŸàŸÑ ÿ®ÿß **ŸÖÿ™ŸÜ Ÿæÿ±ÿ±ŸÜ⁄Ø**
- ŸÖŸàÿ±ÿØ ÿØŸàŸÖ ÿ®ÿß *ŸÖÿ™ŸÜ ⁄©ÿ¨*
- ŸÖŸàÿ±ÿØ ÿ≥ŸàŸÖ ÿ®ÿß \`⁄©ÿØ ÿØÿ±ŸàŸÜ‚ÄåÿÆÿ∑€å\`
- ŸÖŸàÿ±ÿØ ⁄ÜŸáÿßÿ±ŸÖ ÿ®ÿß ŸÅÿ±ŸÖŸàŸÑ $x^2 + y^2 = r^2$

---

## üìã Tables

| Language | Paradigm | Year | Creator |
|----------|----------|------|---------|
| Python | Multi-paradigm | 1991 | Guido van Rossum |
| JavaScript | Multi-paradigm | 1995 | Brendan Eich |
| Rust | Systems | 2010 | Graydon Hoare |
| Go | Concurrent | 2009 | Robert Griesemer |

---

## üìù Lists

### Ordered List

1. First item with **bold text**
2. Second item with \`inline code\`
3. Third item with math: $\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}$
4. Fourth item with a [link](https://example.com)

### Unordered List

- Item with *italics*
- Item with ~~strikethrough~~
- Nested items:
  - Sub-item one
  - Sub-item two
  - Sub-item three

---

## üìö Footnotes

The theory of general relativity[^1] describes gravity as a geometric property of spacetime.

Quantum mechanics[^2] revolutionized our understanding of atomic and subatomic particles.

[^1]: Published by Albert Einstein in 1915.
[^2]: Developed in the early 20th century by Planck, Bohr, Heisenberg, and Schr√∂dinger.

---

## üí¨ Blockquotes

> "The only way to do great work is to love what you do."
> ‚Äî *Steve Jobs*

> üìå **ŸÜ⁄©ÿ™Ÿá ŸÖŸáŸÖ:** ÿß€åŸÜ Ÿæ€åÿ¥‚ÄåŸÜŸÖÿß€åÿ¥⁄Øÿ± ÿ®Ÿá ÿµŸàÿ±ÿ™ ÿÆŸàÿØ⁄©ÿßÿ± ÿ¨Ÿáÿ™ ŸÖÿ™ŸÜ ÿ±ÿß ÿ™ÿ¥ÿÆ€åÿµ ŸÖ€å‚ÄåÿØŸáÿØ.

> \`\`\`
> Code blocks inside blockquotes also work!
> \`\`\`

---

## üé® Text Formatting

- **Bold text** for emphasis
- *Italic text* for subtle emphasis
- ***Bold and italic*** combined
- ~~Strikethrough~~ for deleted text
- \`Inline code\` for technical terms

---

*Built with Marked.js, MathJax, and Prism.js* ‚ú®`;

        // Initialize with sample content
        markdownInput.value = sampleMarkdown;

        if (document.readyState === 'complete') {
            setTimeout(updatePreview, 500);
        } else {
            window.addEventListener('load', () => setTimeout(updatePreview, 500));
        }
    </script>
</body>
</html>
